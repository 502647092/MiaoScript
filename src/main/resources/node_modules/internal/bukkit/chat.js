/*global Java, base, module, exports, require*/
var bukkit = require('api/server');

var nmsChatSerializerClass;
var packetTypeClass;
var nmsChatMessageTypeClass;

var chatMessageTypes;

var String = Java.type('java.lang.String');

var downgrade = false;

function init() {
    nmsChatSerializerClass = bukkit.nmsCls(bukkit.nmsVersion.split("_")[1] > 7 ? "IChatBaseComponent$ChatSerializer" : "ChatSerializer");
    packetTypeClass = bukkit.nmsCls("PacketPlayOutChat");
    var packetTypeConstructor;
    Java.from(packetTypeClass.class.constructors).forEach(function(c) {
        if (c.parameterTypes.length === 2) {
            packetTypeConstructor = c
        }
    });
    nmsChatMessageTypeClass = packetTypeConstructor.parameterTypes[1];
    if (nmsChatMessageTypeClass.isEnum()) {
        chatMessageTypes = nmsChatMessageTypeClass.getEnumConstants();
    } else {
        switch (nmsChatMessageTypeClass.name) {
            case "int":
                nmsChatMessageTypeClass = java.lang.Integer;
                break;
            case "byte":
                nmsChatMessageTypeClass = java.lang.Byte;
                break;
        }
    }
}

function json(sender, json) {
    if (downgrade) {
        bukkit.console('/tellraw ' + sender.name + ' ' + json)
    } else {
        send(sender, json, 0);
    }
}

function send(sender, json, type) {
    sendPacket(sender, new packetTypeClass(nmsChatSerializerClass.a(json), chatMessageTypes == null ? nmsChatMessageTypeClass.valueOf(String.valueOf(type)) : chatMessageTypes[type]))
}

function sendPacket(player, p) {
    player.handle.playerConnection.sendPacket(p);
}

try {
    init();
} catch (ex) {
    console.console("§6[§bbukkit-chat§6] §cNMS Inject Error §4" + ex + " §6Downgrade to Command Mode...")
    downgrade = true;
}

exports = module.exports = {
    json: json
};
